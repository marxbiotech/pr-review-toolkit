# PR Review 工作流程指南

> 一套結合 AI 審查、本地快取、與互動式修復的完整 PR Review 解決方案。

## 為什麼需要這套系統？

傳統的 PR Review 流程往往面臨幾個痛點：

1. **審查品質不一致**：不同審查者關注的面向不同，容易遺漏問題
2. **重複的 API 呼叫**：每次讀取 review comment 都要打 GitHub API，網路慢時體驗很差
3. **離線無法工作**：沒有網路就無法查看之前的審查結果
4. **修復過程缺乏追蹤**：哪些問題已修、哪些延後，全靠人腦記憶

這套系統透過三個核心元件解決這些問題：

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           PR REVIEW TOOLKIT                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   🔍 pr-review-and-document     產出結構化的審查報告，發布到 PR comment     │
│                                                                              │
│   🔧 pr-review-resolver         逐一處理審查問題，與使用者互動決策          │
│                                                                              │
│   💾 本地快取層                  減少 API 呼叫，支援離線工作                │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 系統架構總覽

```
┌──────────────────────────────────────────────────────────────────────────────┐
│  你的專案 (your-project/)                                                    │
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────────┐  │
│  │  .pr-review-cache/                    ← 本地快取（不進 git）           │  │
│  │  ├── pr-123.json                      ← PR #123 的審查快取             │  │
│  │  ├── pr-456.json                      ← PR #456 的審查快取             │  │
│  │  └── ...                                                               │  │
│  └────────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
│  .gitignore                                                                  │
│  └── .pr-review-cache/                   ← 自動添加                         │
└──────────────────────────────────────────────────────────────────────────────┘

                                    │
                                    │ 讀取 / 寫入
                                    ▼

┌──────────────────────────────────────────────────────────────────────────────┐
│  PR Review Toolkit (plugin)                                                  │
│                                                                              │
│  scripts/                                                                    │
│  ├── cache-read-comment.sh    ─┐                                             │
│  ├── cache-write-comment.sh    ├── 快取感知的包裝腳本                       │
│  ├── cache-sync.sh             │                                             │
│  ├── cache-cleanup.sh         ─┘                                             │
│  │                                                                           │
│  ├── find-review-comment.sh   ─┐                                             │
│  └── upsert-review-comment.sh ─┴── 核心 GitHub API 腳本（保持不變）         │
│                                                                              │
│  skills/                                                                     │
│  ├── pr-review-and-document/  ─── 執行完整審查並發布                        │
│  ├── pr-review-resolver/      ─── 互動式處理審查問題                        │
│  ├── pr-cache-sync/           ─── 手動同步快取                              │
│  └── pr-cache-cleanup/        ─── 清理已合併 PR 的快取                      │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## 核心工作流程

### 階段一：執行 PR 審查

當你說「review PR and document」或「執行 PR review」時，系統會啟動完整的審查流程：

```
使用者: "review PR and document"
         │
         ▼
┌──────────────────────────────────────────────────────────────────────────────┐
│  步驟 1: 確認 PR 存在                                                        │
│  gh pr view --json number                                                    │
└──────────────────────────────────────────────────────────────────────────────┘
         │
         ▼
┌──────────────────────────────────────────────────────────────────────────────┐
│  步驟 2: 讀取現有審查（快取感知）                                            │
│                                                                              │
│  cache-read-comment.sh $PR_NUMBER                                            │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │  快取存在？ ──YES──▶ 直接使用快取內容（毫秒級）                        │ │
│  │       │                                                                 │ │
│  │      NO                                                                 │ │
│  │       │                                                                 │ │
│  │       ▼                                                                 │ │
│  │  從 GitHub 取得 → 建立快取 → 回傳內容                                  │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────────────────────────┘
         │
         ▼
┌──────────────────────────────────────────────────────────────────────────────┐
│  步驟 3: 執行六大審查代理                                                    │
│                                                                              │
│  🔍 code-reviewer          程式碼品質與 CLAUDE.md 合規性                    │
│  🧹 code-simplifier        簡化機會                                         │
│  🔇 silent-failure-hunter  靜默失敗與錯誤處理                               │
│  📐 type-design-analyzer   型別設計品質                                     │
│  🧪 pr-test-analyzer       測試覆蓋分析                                     │
│  💬 comment-analyzer       註解準確性與可維護性                             │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
         │
         ▼
┌──────────────────────────────────────────────────────────────────────────────┐
│  步驟 4: 格式化審查報告                                                      │
│                                                                              │
│  產出結構化的 Markdown，包含：                                               │
│  • 隱藏的 metadata（JSON 格式，追蹤 review round、issues 狀態）             │
│  • 摘要表格（Critical / Important / Suggestions 計數）                      │
│  • 各分類的詳細問題清單                                                     │
│  • 行動計畫（Before Merge / After Merge）                                   │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
         │
         ▼
┌──────────────────────────────────────────────────────────────────────────────┐
│  步驟 5: 發布審查（快取感知）                                                │
│                                                                              │
│  cache-write-comment.sh $TEMP_FILE $PR_NUMBER                                │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │  1. 更新本地快取                                                       │ │
│  │  2. 同步到 GitHub（透過 upsert-review-comment.sh）                     │ │
│  │  3. 回傳 comment URL                                                   │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────────────────────────┘
         │
         ▼
    審查完成，PR comment 已發布 ✓
```

---

### 階段二：處理審查問題

審查報告發布後，使用「處理 PR review 問題」或「run pr review resolver」來逐一處理：

```
使用者: "處理 PR review 問題"
         │
         ▼
┌──────────────────────────────────────────────────────────────────────────────┐
│  步驟 1: 讀取審查內容（快取感知）                                            │
│                                                                              │
│  cache-read-comment.sh $PR_NUMBER                                            │
│  ├── 快取命中 → 直接使用（離線也能工作！）                                  │
│  └── 快取未命中 → 從 GitHub 取得並快取                                      │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
         │
         ▼
┌──────────────────────────────────────────────────────────────────────────────┐
│  步驟 2: 解析未解決項目                                                      │
│                                                                              │
│  識別所有標記為 ⚠️ 或 🔴 的問題                                              │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
         │
         ▼
┌──────────────────────────────────────────────────────────────────────────────┐
│  步驟 3: 逐一處理（核心互動）                                                │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │  對每個問題：                                                          │ │
│  │                                                                         │ │
│  │  3.1  呈現問題（引用 review、顯示 file:line）                          │ │
│  │         │                                                               │ │
│  │         ▼                                                               │ │
│  │  3.2  閱讀實際程式碼，驗證問題是否仍存在                               │ │
│  │         │                                                               │ │
│  │         ▼                                                               │ │
│  │  3.3  與使用者討論解決方案                                             │ │
│  │       ┌─────────────────────────────────────────┐                       │ │
│  │       │  選項：                                │                       │ │
│  │       │  • 修復 → 啟動背景子任務               │                       │ │
│  │       │  • 延後 → 標記 ⏭️ Deferred             │                       │ │
│  │       │  • N/A  → 標記 ⏭️ N/A                  │                       │ │
│  │       └─────────────────────────────────────────┘                       │ │
│  │         │                                                               │ │
│  │         ▼                                                               │ │
│  │  3.4  記錄決策，繼續下一個問題                                         │ │
│  │                                                                         │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
         │
         ▼
┌──────────────────────────────────────────────────────────────────────────────┐
│  步驟 4: 驗收所有子任務                                                      │
│                                                                              │
│  • 等待所有背景修復子任務完成                                               │
│  • 驗證修改範圍                                                             │
│  • 更新 review comment（透過 cache-write-comment.sh）                       │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
         │
         ▼
    所有問題已處理，PR 準備好 merge ✓
```

---

## 快取機制詳解

### 為什麼需要快取？

| 場景 | 無快取 | 有快取 |
|------|--------|--------|
| 讀取審查內容 | 每次都打 GitHub API（~500ms） | 本地讀取（~5ms） |
| 網路不穩 | 經常失敗、體驗差 | 照常工作 |
| 完全離線 | 無法使用 | 可以查看、編輯（稍後同步） |
| 多次執行 resolver | 重複 API 呼叫 | 只在首次或手動刷新時呼叫 |

### 快取檔案結構

快取儲存在你的專案目錄下的 `.pr-review-cache/` 資料夾：

```json
{
  "schema_version": "1.0",
  "pr_number": 123,
  "source_comment_id": 456789,
  "cached_at": "2026-02-05T10:30:00Z",
  "pr_state": "OPEN",
  "branch": "feature/my-branch",
  "base": "main",
  "content": "<!-- pr-review-metadata\n...\n-->\n\n## PR Review\n...",
  "content_hash": "sha256:abc123..."
}
```

### 讀取流程

```
cache-read-comment.sh [PR_NUMBER] [--force-refresh]
                      │
                      ▼
          ┌───────────────────────────┐
          │  指定 --force-refresh？   │
          └───────────────────────────┘
                │            │
               YES          NO
                │            │
                │            ▼
                │   ┌───────────────────────────┐
                │   │  快取檔案存在？           │
                │   │  .pr-review-cache/pr-N.json│
                │   └───────────────────────────┘
                │         │            │
                │        YES          NO
                │         │            │
                │         ▼            │
                │   ┌─────────────┐    │
                │   │ 讀取快取    │    │
                │   │ （超快！）  │    │
                │   └─────────────┘    │
                │         │            │
                │         ▼            │
                │    回傳內容          │
                │                      │
                ▼                      ▼
        ┌─────────────────────────────────────┐
        │         從 GitHub 取得              │
        │  1. find-review-comment.sh → ID     │
        │  2. gh api → 取得 body              │
        │  3. gh pr view → state, branch      │
        └─────────────────────────────────────┘
                        │
                        ▼
              ┌─────────────────┐
              │  建立/更新快取  │
              └─────────────────┘
                        │
                        ▼
                   回傳內容
```

### 寫入流程

```
cache-write-comment.sh <CONTENT_FILE> [PR_NUMBER] [--local-only]
                        │
                        ▼
              ┌─────────────────┐
              │  更新本地快取   │
              └─────────────────┘
                        │
                        ▼
          ┌───────────────────────────┐
          │  指定 --local-only？      │
          └───────────────────────────┘
                │            │
               YES          NO
                │            │
                ▼            ▼
          ┌──────────┐  ┌─────────────────────┐
          │ 完成     │  │  同步到 GitHub      │
          │（僅快取）│  │  upsert-review-     │
          └──────────┘  │  comment.sh         │
                        └─────────────────────┘
                                  │
                                  ▼
                          回傳 comment URL
```

---

## 快取管理

### 手動同步快取

當你懷疑快取過期，或想確保擁有最新內容：

```
使用者: "sync PR cache" / "refresh cache" / "update local cache"
         │
         ▼
┌──────────────────────────────────────────────────────────────────────────────┐
│  cache-sync.sh $PR_NUMBER                                                    │
│                                                                              │
│  1. 顯示舊快取時間戳記（若存在）                                            │
│  2. 強制從 GitHub 重新取得                                                  │
│  3. 比較 hash 偵測變更                                                      │
│  4. 報告結果                                                                │
│                                                                              │
│  輸出範例：                                                                 │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │  === PR Review Cache Sync ===                                          │ │
│  │  PR #123                                                               │ │
│  │                                                                        │ │
│  │  Previous cache: 2026-02-05T10:30:00Z                                  │ │
│  │  Previous hash: sha256:abc123...                                       │ │
│  │                                                                        │ │
│  │  Fetching from GitHub...                                               │ │
│  │                                                                        │ │
│  │  New cache: 2026-02-05T14:45:00Z                                       │ │
│  │  New hash: sha256:def456...                                            │ │
│  │                                                                        │ │
│  │  ⚠️  Content changed since last cache!                                 │ │
│  │                                                                        │ │
│  │  === Sync complete ===                                                 │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────────────────────────┘
```

### 清理過期快取

當 PR 合併或關閉後，其快取就不再需要了：

```
使用者: "clean up cache" / "cleanup merged PR caches"
         │
         ▼
┌──────────────────────────────────────────────────────────────────────────────┐
│  cache-cleanup.sh [--dry-run] [--all]                                        │
│                                                                              │
│  對每個 .pr-review-cache/pr-*.json：                                        │
│  1. 查詢 PR 狀態                                                            │
│  2. 若 MERGED 或 CLOSED → 刪除快取                                          │
│  3. 報告刪除/保留數量                                                       │
│                                                                              │
│  輸出範例：                                                                 │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │  === PR Review Cache Cleanup ===                                       │ │
│  │                                                                        │ │
│  │  Scanning cache files...                                               │ │
│  │                                                                        │ │
│  │  Deleted: pr-120.json (PR #120, state: MERGED)                         │ │
│  │  Deleted: pr-121.json (PR #121, state: CLOSED)                         │ │
│  │  Keeping: pr-123.json (PR #123 is still open)                          │ │
│  │                                                                        │ │
│  │  === Summary ===                                                       │ │
│  │  Deleted: 2 files                                                      │ │
│  │  Kept: 1 files                                                         │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## 快速參考

### 指令觸發詞彙

| Skill | 觸發詞 |
|-------|--------|
| pr-review-and-document | "review PR and document", "執行 PR review", "create PR review document" |
| pr-review-resolver | "處理 PR review 問題", "run pr review resolver", "逐一處理 review issues" |
| pr-cache-sync | "sync PR cache", "refresh cache", "update local cache", "pull latest review" |
| pr-cache-cleanup | "clean up cache", "cleanup merged PR caches", "remove old caches" |

### 初始設定

**不需要手動設定！** 當快取腳本首次建立 `.pr-review-cache/` 目錄時，會自動將其加入 `.gitignore`。

你只需要在變更後 commit 即可：

```bash
git add .gitignore
git commit -m "chore: ignore PR review cache directory"
```

### 日常工作流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  場景：開始處理有 review 的 PR                                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  1. 執行「處理 PR review 問題」                                             │
│     └── 系統自動檢查快取                                                    │
│         ├── 快取存在 → 直接使用（快！）                                     │
│         └── 快取不存在 → 從 GitHub 取得並快取                               │
│                                                                              │
│  2. 若懷疑快取過期，執行「sync PR cache」                                   │
│     └── 強制從 GitHub 重新取得，更新本地快取                                │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│  場景：合併多個 PR 後                                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  1. 執行「clean up cache」                                                  │
│     └── 顯示將被刪除的檔案預覽                                              │
│     └── 刪除已合併/關閉 PR 的快取                                           │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│  場景：離線或網路不穩時                                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  1. 在有網路時執行 review，讓快取建立                                       │
│  2. 離線時仍可查看、處理快取的審查內容                                      │
│  3. 使用 --local-only 寫入，稍後再同步                                      │
│  4. 網路恢復後執行 sync 同步到 GitHub                                       │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 設計決策

| 決策 | 選擇 | 理由 |
|------|------|------|
| 快取鍵 | PR 編號（`pr-{N}.json`） | 唯一、穩定、符合現有腳本模式 |
| 快取位置 | 專案目錄下 `.pr-review-cache/` | 與 `.git/`、`.vscode/` 模式一致 |
| 整合方式 | 包裝腳本 | 乾淨分離，核心腳本保持不變 |
| 快取格式 | JSON（含 metadata + content） | 支援過期偵測、稽核軌跡 |

---

## 疑難排解

### 快取沒有被使用

1. 確認 `.pr-review-cache/` 目錄存在
2. 確認對應 PR 編號的快取檔案存在
3. 使用 `--force-refresh` 繞過快取並重建

### 快取內容過期

執行 `cache-sync.sh` 強制從 GitHub 重新取得，或使用 `--force-refresh` 標記。

### 快取佔用空間

執行 `cache-cleanup.sh` 清理已合併/關閉 PR 的快取。
